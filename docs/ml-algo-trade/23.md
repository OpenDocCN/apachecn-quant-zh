# 二十三、结论和下一步

本书的目标是使您能够将**机器学习**（**ML**）应用于各种数据源，并提取为交易策略增值的信号。为此，我们更全面地审视了投资过程，从创意生成到战略评估，并以**ML4T 工作流**的形式将 ML 作为该过程的一个重要元素引入。

在演示从基础到高级的各种 ML 算法的使用时，我们看到了 ML 如何在设计、测试和执行策略的过程中的多个步骤中增加价值。然而，在大多数情况下，我们关注的是**核心 ML****价值主张**，它包括从比人类专家更系统的大量数据中提取可操作信息的能力。

随着数字数据的爆炸式增长，这一价值主张得到了广泛认可，这使得利用计算能力从越来越多样化的信息中提取价值变得更有希望和必要。然而，ML 的应用仍然需要大量的人工干预和领域专业知识来定义目标、选择和管理数据、设计和优化模型，并适当利用结果。

使用 ML 进行交易的领域特定方面包括金融数据的性质和金融市场的环境。当信噪比与金融数据一样低时，使用具有高模式学习能力的强大模型需要特别小心，以避免过度拟合。此外，交易的竞争性质意味着模式随着信号衰减而迅速演变，需要额外关注性能监控和模型维护。

在这最后一章中，我们将简要总结本书中的关键工具、应用程序和经验教训，以避免在过多的细节之后忽略大局。然后，我们将确定我们没有涵盖但值得关注的领域，因为您将扩展我们介绍的许多 ML 技术，并在日常使用中变得高效。

总之，在本章中，我们将：

*   回顾主要收获和经验教训
*   指出建立在本书技术基础上的下一步
*   建议将 ML 纳入投资流程的方法

# 主要收获和经验教训

本书的中心目标是演示使用 ML 从数据中提取信号以通知交易策略的工作流程。*图 23.1*概述了该交易流程的 ML。本节总结的关键要点与我们在金融市场背景下为大型数据集构建复杂预测模型时遇到的具体挑战有关：

![](img/B15439_23_01.png)

图 23.1：使用 ML 进行交易的关键要素

在进行 ML 交易实践时，需要牢记的重要见解包括：

*   **数据**是唯一最重要的成分，需要仔细寻找和处理。
*   **领域专业知识**是实现数据中包含的价值和避免使用 ML 的一些陷阱的关键。
*   ML 提供了**工具**，您可以调整并结合这些工具为您的用例创建解决方案。
*   **模型目标和性能诊断**的选择是向最优系统进行生产性迭代的关键。
*   **回测过度拟合**是一个巨大的挑战，需要高度重视。
*   **黑箱模型的透明度**有助于建立信心，促进怀疑论者采用 ML。

我们将对每一个想法进行详细阐述。

## 数据是最重要的组成部分

ML 在交易和其他领域的崛起在很大程度上补充了我们在中详细介绍的数据爆炸。我们在*第 2 章*、*市场和基础数据–来源和技术*中说明了如何访问和使用这些数据源，这些数据源在历史上一直是定量投资的支柱。在*第 3 章**金融备选数据–类别和用例*中，我们制定了一个框架和标准来评估备选数据集的潜在价值。

一个关键的洞察是，像深度神经网络这样的最先进的 ML 技术是成功的，因为它们的预测性能随着数据的增加而不断提高。另一方面，模型和数据复杂性需要匹配以平衡偏差-方差权衡，数据的信噪比越高，这就越具有挑战性。管理数据质量和集成数据集是实现潜在价值的关键步骤。

### 新的石油？原始和中间数据的质量控制

就像如今流行的对比石油一样，数据通过一条**管道，经过几个阶段**，从原始形态到能够推动交易策略的精炼产品。仔细关注最终产品的质量对于获得所需里程数至关重要。

有时，您会获得原始形式的**数据**，并控制为您的目的所需的大量转换。更常见的情况是，您处理的是一个**中间产品**，并且应该弄清楚数据在这一点上究竟测量了什么。

与石油不同的是，随着数据源的不断增加，通常**没有客观的质量标准**。相反，质量取决于其信号内容，而信号内容又取决于您的投资目标。对新数据集进行经济高效的评估需要高效的工作流程，包括我们将在本章后面介绍的适当基础设施。

### 数据集成–整体超过部分之和

投资策略的数据价值通常取决于市场、基本面和备选数据的互补来源的组合。我们发现，ML 算法的预测能力，如基于树的集合或神经网络，部分是由于它们能够检测非线性关系，特别是变量之间的**交互效应**。

将变量的影响调节为其他模型特征的函数的能力在捕获目标结果不同方面的数据输入上蓬勃发展。资产价格与宏观基本面、社会情感、信用卡支付和卫星数据的结合，可能会在不同的经济和市场制度中产生比每个来源本身更可靠的预测（前提是数据量足够大，足以了解隐藏的关系）。

使用来自多个来源的数据增加了正确标记的**挑战。分配准确反映历史出版物的准确时间戳至关重要。否则，我们通过在算法实际可用之前用数据测试算法来引入前瞻性偏差。例如，第三方数据可能具有需要调整的时间戳，以反映信息可用于实时算法的时间点。**

## 领域专业知识–从噪音中辨别信号

我们强调信息性数据是成功应用 ML 的必要条件。然而，领域专业知识对于定义战略方向、选择相关数据、设计信息特征和设计稳健模型同样重要。

在任何领域，从业者都有关于关键结果驱动因子及其相互关系的理论。金融学的特点是大量可用的定量研究，包括理论研究和实证研究。然而，Marcos López de Prado 和其他人（Cochrane 2011）批评了大多数实证结果：在数百个变量中发现的预测信号的主张通常基于普遍的数据挖掘，对实验设置的变化不可靠。换句话说，统计显著性通常来自大规模的试验和错误，而不是真正的系统关系，即“如果你对数据折磨足够长的时间，它会坦白。”

一方面，人们对金融市场如何运作有着深刻的理解。这应告知选择和使用数据以及依赖 ML 的策略的理由。一个重要原因是优先考虑更有可能成功的想法，并避免导致不可靠结果的多重测试陷阱。我们在*第 4 章*、*金融特征工程——如何研究阿尔法因子*和*第 5 章*、*投资组合优化和表现评估*中概述了关键思想。

另一方面，新的 ML 技术可能会发现有关金融结果驱动因子的新假设，这些假设将为理论提供信息，然后应进行独立测试。

与原始数据相比，特征工程通常是使信号对算法有用的关键。利用数十年来在理论和实证基础上推动回报的风险因子研究，是一个很好的起点，可以优先考虑更可能反映相关信息的数据转换。

然而，只有创造性的特征工程才能带来能够在市场上长期竞争的创新战略。即使是对于新的阿尔法因子，在市场动态和投资者行为的既定理念下，解释这些因子如何发挥作用的引人入胜的叙述也将为资本配置提供更多信心。

错误发现和过度拟合历史数据的风险使得在测试之前更需要优先考虑策略，而不是“让数据说话”。我们在*第 7 章*、*线性模型中介绍了如何降低夏普比率——从风险因子到回报预测*，说明实验的数量。

## ML 是解决数据问题的工具包

ML 提供可应用于许多用例的算法解决方案和技术。本书的*部分 2*、*3*和*4*将 ML 作为一套多样化的工具，可以为战略过程的各个步骤增加价值，包括：

*   创意生成与α因子研究
*   信号聚合与组合优化
*   策略测试
*   交易执行
*   战略评估

此外，ML 算法被设计为进一步开发、调整和组合，以解决不同环境中的新问题。出于这些原因，理解这些算法背后的关键概念和思想非常重要，除了能够将它们应用于生产性实验和研究的数据，如*第 6 章*、*机器学习过程*和*图 23.2*中总结的：

![](img/B15439_23_02.png)

图 23.2:ML 工作流程

此外，最好的结果通常是通过**人在回路解决方案**将人与 ML 工具结合起来实现的。在*第 1 章**交易机器学习——从想法到执行*中，我们介绍了自由裁量和算法交易融合的量子投资风格。这种方法的重要性可能会进一步增加，这取决于我们介绍的基本工具的灵活和创造性应用，以及它们对各种数据集的扩展。

### 模型诊断有助于加速优化

在*第 6 章**机器学习过程*中，我们概述了最重要的 ML 特定概念。ML 算法通过对函数形式的假设来学习输入数据和目标之间的关系。如果学习基于噪声而不是信号，预测性能将受到影响。

当然，我们今天不知道如何从明天的结果的角度区分信号和噪声。谨慎的交叉验证可避免前瞻性偏差和稳健的模型诊断，如学习曲线和优化验证测试，有助于缓解这一基本挑战，并校准算法的选择或配置。通过定义重点模型目标，以及对于复杂模型，区分由于优化算法问题而导致的性能缺陷和目标本身的性能缺陷，可以简化此任务。

### 没有免费午餐勉强度日

没有一个系统，无论是计算机程序还是人类，能够可靠地预测训练期间观察到的新例子的结果。唯一的出路是掌握一些额外的先验知识或做出超出培训示例范围的假设。我们涵盖了广泛的算法，从*第 7 章*中的线性模型、*线性模型——从风险因子到回报预测*，到*第 11 章*、*随机森林——日本股票的长-短策略*和*第 12 章*中的非线性集合，*提升您的交易策略*，以及本书*第 4 部分*各章节中的神经网络。

我们看到，线性模型强烈假设输入和输出之间的关系具有非常简单的形式，而梯度增强或神经网络等非线性模型旨在学习更复杂的函数。虽然很明显，一个简单的模型在大多数情况下都会失败，但一个复杂的模型并不总是更好。如果真实关系是线性的，但数据是有噪声的，则复杂模型将学习噪声作为其假定存在的复杂关系的一部分。这是**“没有免费午餐”定理**背后的基本思想，该定理指出，对于所有任务，没有算法是普遍优越的。在某些情况下，良好的匹配是以其他地方性能不佳为代价的。

根据数据选择算法的关键工具是数据探索和基于对模型假设的理解的实验。

### 管理偏差-方差权衡

使算法适应数据的一个关键挑战是偏差和方差之间的权衡，这两者都会增加预测误差，超出数据的自然噪声。如果一个简单的模型不能充分捕捉数据中的关系，那么该模型就会拟合不足并表现出偏差，也就是说，做出系统性错误的预测。过于复杂的模型将过度拟合并学习任何信号之外的噪声，因此结果将显示不同样本的大量方差。

在模型选择和优化过程的任何给定迭代中，诊断这种权衡的关键工具是**学习曲线**。它显示了训练和验证错误如何依赖于样本大小。这允许我们在不同的选项之间做出决定，以提高性能：调整模型的复杂性或获取更多数据点。

训练误差越接近人的表现或其他基准，模型越有可能过度拟合。低验证错误告诉我们，我们很幸运，找到了一个好的模型。如果验证错误很高，则我们不是。然而，如果它继续随着训练规模的增加而下降，更多的数据可能会有所帮助。如果训练误差很大，那么更多的数据不太可能有帮助，我们应该增加特征或使用更灵活的算法。

### 定义有针对性的模型目标

ML 过程中的第一步是定义算法优化的目标。有时，选择很简单，例如在回归问题中。例如，当我们关心精确性和召回率时，分类任务可能会更困难。将相互冲突的目标整合到一个单一指标（如 F1 分数）有助于集中优化工作。我们还可以包括需要满足而不是优化的条件。我们还看到强化学习是关于定义正确的奖励函数来指导智能体的学习过程。

### 优化验证试验

安得烈 NG 强调了由于学习算法或优化算法存在的问题而导致的性能缺陷之间的区别。像神经网络这样的复杂模型假设了非线性关系，优化算法的搜索过程可能会以局部最优而不是全局最优结束。

例如，如果模型无法正确翻译短语，测试将比较正确预测的分数和搜索算法发现的解决方案。如果学习算法对正确解的得分较高，则搜索算法需要改进。否则，学习算法将针对错误的目标进行优化。

## 注意回测过度装配

在整本书中，我们反复讨论了由于过度拟合历史数据而导致错误发现的风险。*第 5 章*、*投资组合优化和表现评估*关于战略评估，列出了的主要驱动因子和潜在补救措施。低信噪比和相对较小的数据集（与网络规模的图像或文本数据相比）使得这一挑战在交易领域尤为严重。意识是至关重要的，因为易于访问数据和工具以应用 ML 会显著增加风险。

没有简单的答案，因为风险是不可避免的。然而，我们提出了调整回溯测试指标的方法，以考虑重复试验，例如缩小的夏普比率。在制定实时交易策略时，分阶段的纸面交易和在市场执行期间密切监控的表现需要成为实施过程的一部分。

## 如何从黑盒模型中获得见解

当深层神经网络和复杂集成被认为是不可穿透的黑盒模型时，会引起怀疑，特别是考虑到回测过度拟合的风险。我们在*第 12 章**提升您的交易策略*中介绍了几种方法来深入了解这些模型是如何进行预测的。

除了特征重要性的常规度量之外，最近的博弈论创新**SHapley 加法解释**（**SHAP**）是理解复杂模型的机制的重要一步。SHAP 值允许准确地将特征及其值归因于预测，以便根据给定投资目标的市场行为的特定理论更容易验证模型的逻辑。除了证明理由外，准确的特征重要性得分和预测归因还可以更深入地了解投资结果的驱动因子。

另一方面，关于模型预测的透明度应该有多重要，存在一些争议。杰弗里·辛顿是深度学习的发明者之一，他认为人类做出决定的原因往往是模糊的。也许机器应该根据其结果进行评估，就像我们对投资经理所做的那样。

# ML 用于实际交易

当您继续将众多工具和技术集成到您的投资和交易过程中时，您可以将精力集中在许多事情上。如果你的目标是做出更好的决定，你应该根据你目前的技能选择既现实又雄心勃勃的项目。这将帮助您开发以生产工具为基础的高效工作流程，并获得实践经验。

我们将简要列出一些工具，这些工具对于扩展本书中介绍的 Python 生态系统非常有用。它们包括大数据技术，这些技术最终将是大规模实施 ML 驱动的交易策略所必需的。我们还将列出一些允许您使用 Python 实现交易策略的平台，这些平台可以访问数据源、ML 算法和库。最后，我们将指出采用 ML 作为组织的良好实践。

## 数据管理技术

数据在 ML4T 过程中的核心作用要求熟悉一系列大规模存储、转换和分析数据的技术，包括使用基于云的服务，如 Amazon Web services、Microsoft Azure 和 Google cloud。

### 数据库系统

数据存储意味着使用数据库。历史上，这些系统通常是**关系数据库管理系统**（**RDBMS**），使用 SQL 以定义良好的表格式存储和检索数据。其中包括来自 Oracle 和 Microsoft 等商业提供商的数据库，以及 PostgreSQL 和 MySQL 等开源实现。最近，出现了非关系替代方案，这些替代方案通常被统称为 NoSQL，但非常多样化，即：

*   **键值存储**：对对象的快速读写访问。我们在*第 2 章*、*市场和基础数据–来源和技术*中介绍了 HDF5 格式，这有助于快速访问熊猫数据帧。
*   **列存储**：利用列中数据的同质性，方便压缩和更快的基于列的操作，如聚合。这在流行的 Amazon Redshift 数据仓库解决方案、Apache Parquet、Cassandra 和 Google 的大表中使用。
*   **文档存储**：设计用于存储违反 RDBMS 所需的严格模式定义的数据。这已经被使用 JSON 或 XML 格式的 web 应用程序所推广，我们在*第 4 章*、*金融特征工程——如何研究阿尔法因子*中遇到了这一点。例如，它在 MongoDB 中使用。
*   **图形数据库**：设计用于存储具有节点和边的网络，专门查询网络度量和关系。它用于 Neo4J 和 ApacheGiraph。

关系数据库系统所建立的约定在某种程度上趋于一致。Python 生态系统促进了与许多标准数据源的交互，并提供了快速的 HDF5 和拼花格式，如本书所示。

### 大数据技术——从 Hadoop 到 Spark

数百 GB 及以上规模的数据管理需要使用多台机器组成集群，并行执行读、写和计算操作。换句话说，您需要一个以集成方式在多台机器上运行的分布式系统。

**Hadoop 生态系统**已经作为一个开源软件框架出现，用于使用谷歌开发的 MapReduce 编程模型分布式存储和处理大数据。在 APACHE 基金会的屋顶下，生态系统已经多样化，今天包括了许多涵盖不同规模的数据管理方面的项目。

Hadoop 中的关键工具包括：

*   **Apache Pig**：Yahoo 开发的数据处理语言，用于使用 MapReduce 实现大规模**提取转换加载**（**ETL**）管道。
*   **ApacheHive**：针对 PB 级数据的交互式 SQL 查询的事实标准。它是在 Facebook 上开发的。
*   **Apache HBASE**：用于实时读/写访问的 NoSQL数据库，可线性扩展到数十亿行和数百万列。它可以使用各种不同的模式组合数据源。

**Apache Spark**已成为集群上最流行的互动分析平台。MapReduce 框架允许并行计算，但需要从磁盘重复读/写操作以确保数据冗余。Spark 通过**弹性分布式数据**（**RDD**结构）在规模上显著加快了计算速度，允许高度优化内存计算。这包括优化所需的迭代计算，例如，许多 ML 算法的梯度下降。幸运的是，Spark DataFrame 界面的设计考虑到了熊猫，因此您的技能转移相对平稳。

## ML 工具

本书介绍了 Python 生态系统的许多库。Python 已经发展成为数据科学和 ML 的选择语言。开源库集继续多样化和成熟，并建立在科学计算库 NumPy 和 SciPy 的强大核心之上。

广受欢迎的 pandas 库为普及 Python 在数据科学中的应用做出了重大贡献，并随着 2020 年 1 月 1.0 版的发布而成熟。scikit 学习界面已经成为现代专门的 ML 库（如 XGBoost 或 LightGBM）的标准，这些库通常与我们在本书中反复使用的工作流自动化工具（如 GridSearchCV 和 Pipeline）进行交互。

有几个提供商旨在促进 ML 工作流：

*   **H2O.ai**提供 H2O 平台，将云计算与 ML 自动化相结合。它允许用户将数千个潜在模型与数据相匹配，以探索数据中的模式。它有 Python 以及 R 和 Java 的接口。
*   **Datarobot**旨在通过提供一个平台，在云端或本地快速构建和部署预测模型，从而实现模型开发过程的自动化。
*   **Dataiku**是一个协作数据科学平台，旨在帮助分析师和工程师探索、原型化、构建和交付他们自己的数据产品。

在 Python 生态系统的基础上构建和扩展的公司还领导了一些开源计划：

*   定量对冲基金**TwoSigma**为 Bikerx 项目下的 Jupyter 笔记本环境提供定量分析工具。
*   **彭博社**已将 Jupyter 笔记本集成到其终端中，以便于对其金融数据进行交互分析。

## 在线交易平台

开发使用 ML 的交易策略的主要选择是在线平台，这些平台通常寻找并将资本分配给成功的交易策略。流行的解决方案包括 Quantopian、Quantconnect 和 QuantRocket。最近的阿尔法交易实验室专注于高频交易。此外，**交互式经纪人****（IB）**提供了一个 Python API，您可以使用它开发自己的交易解决方案。

### 全域

我们介绍了 Quantopian 平台，并演示了如何使用其研究和交易环境，根据历史数据分析和测试交易策略。Quantopian 使用 Python 并提供了大量教育材料。

Quantopian 举办竞赛，为其众包对冲基金投资组合招募算法。它为获胜的算法提供了资金。直播交易于 2017 年 9 月停止，但该平台仍提供大量历史数据，并吸引了活跃的开发商和交易员社区。这是讨论想法和向他人学习的良好起点。

### 量子连接

QuantConnect 是另一个与 Quantopian 竞争的开源、社区驱动的算法交易平台。它还提供了一个 IDE，用于使用 Python 和其他语言进行回溯测试和实时交易算法策略。

QuantConnect 还拥有一个来自世界各地的充满活力的全球社区，并提供对多种资产类别的访问，包括股票、期货、外汇和加密货币。它提供与各种经纪人的实时交易集成，如 IB、OANDA 和 GDAX。

### 量子点

QuantRocket 是一个基于 Python 的平台，用于研究、回溯测试和运行自动化定量交易策略。它提供数据收集工具、多个数据供应商、一个研究环境、多个回溯测试引擎以及通过 IB 进行的实时和书面交易。它以支持国际股票交易而自豪，并以其灵活性而与众不同（但 Quantopian 也在努力实现这一点）。

QuantRocket 支持多个引擎——它自己的 Moonshot，以及用户选择的第三方引擎。虽然 QuantRocket 没有传统的 IDE，但它与 Jupyter 很好地集成，可以生成类似的东西。QuantRocket 提供了一个免费版本，可以访问样本数据，但在 2020 年初撰写本文时，访问更广泛的功能集的价格为每月 29 美元。

# 结论

我们首先强调了数字数据的爆炸性增长以及 ML 作为投资和交易战略战略能力的出现。这一动态反映了金融以外的全球商业和技术趋势，而且更可能持续下去，而不是停滞或逆转。正如导言章节所述，许多投资公司刚刚开始利用一系列人工智能工具，而个人正在获得相关技能，业务流程正在适应这些新的价值创造机会。

将 ML 应用于地平线上的交易也有许多令人兴奋的发展，可能推动当前的势头。它们可能在未来几年变得相关，包括 ML 过程的自动化、合成训练数据的生成以及量子计算的出现。这一领域的非凡活力意味着，仅此一点就足以填满一本书，而这一旅程将继续令人兴奋。